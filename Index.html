<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>The Nightâ€™s Choice</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0f">

<style>
  :root{
    --bg:#0b0b0f;
    --panel:#13131a;
    --panel-2:#181824;
    --accent:#d79ab8; /* romantic rose */
    --accent-2:#7ad1cc; /* soft teal */
    --text:#f2f2f5;
    --muted:#a9abbb;
    --chip:#262636;
    --good:#7cd992;
    --warn:#ffcf6e;
    --danger:#ff6e8a;
    --glow:0 0 20px rgba(215,154,184,.35);
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:env(safe-area-inset-top) 16px 64px}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,11,15,.95),rgba(11,11,15,.8) 70%,rgba(11,11,15,0));backdrop-filter:blur(6px);z-index:5}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 4px}
  .title-tappable{font-weight:700;letter-spacing:.5px;font-size:20px;color:var(--text);text-shadow:0 0 14px rgba(122,209,204,.12);padding:8px 10px;border-radius:8px}
  .title-tappable:active{transform:scale(.98)}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select,button,.btn{background:var(--panel);color:var(--text);border:1px solid #222331;border-radius:10px;padding:10px 12px;font-size:14px}
  select{appearance:none}
  button.primary{background:linear-gradient(180deg,#272737,#1b1b28);border-color:#2b2c3d;box-shadow:var(--glow)}
  button.primary:active{transform:scale(.99)}
  .upload-label{display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px dashed #34354a;padding:10px 12px;border-radius:10px;background:var(--panel-2)}
  .upload-label:hover{border-color:#4a4c66}
  input[type=file]{display:none}

  .machine{margin-top:16px;background:radial-gradient(1200px 600px at 50% -200px,#1a1a26,#0e0e14 70%);border:1px solid #24253a;border-radius:18px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02)}
  .reels{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;margin:8px 0 14px}
  .reel{height:120px;background:linear-gradient(180deg,#151521,#0f0f16);border:1px solid #23243a;border-radius:12px;overflow:hidden;position:relative}
  .strip{position:absolute;inset:0;display:flex;flex-direction:column;gap:6px;filter:blur(0);will-change:transform}
  .cell{height:120px;display:flex;align-items:center;justify-content:center;opacity:.9}
  .cell img{height:100%;object-fit:cover;border-radius:8px}
  .reveal{position:relative;margin-top:8px;border-radius:14px;overflow:hidden;border:1px solid #23243a;background:#0f0f15;min-height:48vh;display:grid;place-items:center}
  .reveal img{max-width:100%;max-height:100%;display:block}
  .watermark{position:absolute;bottom:8px;right:10px;font-size:12px;color:#fff8;border-radius:6px;padding:4px 6px;background:linear-gradient(180deg,#181826AA,#0f0f15AA);backdrop-filter:blur(4px)}
  .spinbar{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px}
  .thumbs{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
  .thumb{position:relative;border:1px solid #23243a;background:#12121a;border-radius:10px;overflow:hidden}
  .thumb img{width:100%;height:100px;object-fit:cover;display:block}
  .chip{position:absolute;left:6px;top:6px;background:var(--chip);color:var(--text);font-size:11px;padding:4px 6px;border-radius:999px;border:1px solid #343652}
  .weight-tag{position:absolute;right:6px;top:6px;font-size:11px;background:#1f1f2c;border:1px solid #343652;color:var(--accent);padding:2px 6px;border-radius:8px}

  /* Hidden rig panel (only via triple tap + PIN) */
  dialog#rig{width:min(900px,96vw);border:none;border-radius:14px;background:linear-gradient(180deg,#13131c,#0c0c12);color:var(--text);padding:0;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.6)}
  #rig header{position:sticky;top:0;padding:14px;border-bottom:1px solid #27283c;background:#12121b}
  #rig .body{padding:12px 14px;display:grid;grid-template-columns:260px 1fr;gap:12px}
  .rig-left{display:flex;flex-direction:column;gap:10px}
  .rig-card{background:#161625;border:1px solid #27283c;border-radius:12px;padding:10px}
  .rig-card h4{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600}
  .rig-input{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .rig-input input[type=number], .rig-input input[type=text]{width:100%;background:#0e0e16;color:var(--text);border:1px solid #2a2b40;border-radius:8px;padding:8px}
  .rig-input button{white-space:nowrap}
  .rig-queue{display:flex;gap:6px;flex-wrap:wrap}
  .rig-queue .pill{background:#1a1a28;border:1px solid #2a2b40;color:#ddd;padding:6px 8px;border-radius:999px;font-size:12px}
  .rig-right{display:flex;flex-direction:column;gap:10px}
  .rig-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
  .rig-item{border:1px solid #2a2b40;background:#12121b;border-radius:10px;overflow:hidden}
  .rig-item img{width:100%;height:110px;object-fit:cover;display:block}
  .rig-item .meta{padding:6px 8px;font-size:12px;display:grid;gap:6px}
  .rig-item select, .rig-item input{width:100%;background:#0e0e16;color:var(--text);border:1px solid #2a2b40;border-radius:8px;padding:6px}
  .close-x{margin-left:auto}
  .hidden{display:none !important}

  .hint{font-size:12px;color:var(--muted)}
  .note{font-size:12px;color:var(--warn)}
  .danger{color:var(--danger)}
  .ok{color:var(--good)}
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div id="titleTap" class="title-tappable">The Nightâ€™s Choice</div>
    <div class="controls">
      <label class="upload-label">
        <input id="fileInput" type="file" accept="image/*" multiple>
        <span>âž• Upload images</span>
      </label>
      <select id="categoryFilter">
        <option value="">All categories</option>
      </select>
      <button id="spinBtn" class="primary">ðŸŽ° Spin</button>
      <button id="clearBtn" title="Remove all images">Reset</button>
    </div>
  </div>
</header>

<div class="wrap">
  <section class="machine">
    <div class="reels" id="reels">
      <div class="reel"><div class="strip"></div></div>
      <div class="reel"><div class="strip"></div></div>
      <div class="reel"><div class="strip"></div></div>
    </div>
    <div class="reveal" id="reveal"><div class="watermark">Tap ðŸŽ° Spin</div></div>
    <div class="spinbar">
      <span id="status" class="hint"></span>
    </div>
  </section>

  <section class="thumbs" id="thumbs"></section>
</div>

<!-- Hidden Rig Panel (only via triple-tap + PIN 1616) -->
<dialog id="rig">
  <header style="display:flex;align-items:center;gap:10px">
    <strong>Rig Control</strong>
    <span class="hint">Keep this our little secret.</span>
    <button class="close-x" id="rigClose">âœ•</button>
  </header>
  <div class="body">
    <div class="rig-left">
      <div class="rig-card">
        <h4>Quick rig queue (next 5 picks)</h4>
        <div class="rig-input">
          <input id="queueId" type="text" placeholder="Paste Image ID">
          <button id="queueAdd">Add</button>
          <button id="queueClear">Clear</button>
        </div>
        <div id="queueView" class="rig-queue"></div>
        <div class="hint">Tip: tap an image in the grid to copy its ID.</div>
      </div>
      <div class="rig-card">
        <h4>Category restriction</h4>
        <select id="rigCategory"></select>
        <div class="hint">Restrict spins to this category until changed.</div>
      </div>
      <div class="rig-card">
        <h4>Sound</h4>
        <div class="rig-input">
          <button id="muteToggle">Mute</button>
          <span id="muteState" class="hint"></span>
        </div>
      </div>
    </div>
    <div class="rig-right">
      <div class="rig-card">
        <h4>Image controls (weights & categories)</h4>
        <div id="rigGrid" class="rig-grid"></div>
      </div>
    </div>
  </div>
</dialog>

<script>
/* ========= Constants & Categories ========= */
const CATEGORIES = [
 "Missionary","Woman-on-top","Oral for Her","Oral for Him",
 "Sitting","Standing","Side-by-Side","Deep Penetration",
 "69","Rear Entry","BDSM for Lovers","Adventurous"
];

const DEFAULT_WEIGHT = 1;
const SPIN_DURATION_MS = 3000;
const PIN = "1616";

/* ========= Storage Layer =========
   Images -> IndexedDB (Blob + metadata)
   Small settings -> localStorage
*/
const DB_NAME = 'nights-choice-db';
const DB_STORE = 'images';
let db;

/* IndexedDB helpers */
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = (ev)=>{
      const db = ev.target.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        const store = db.createObjectStore(DB_STORE,{ keyPath:'id' });
        store.createIndex('category','category',{unique:false});
        store.createIndex('ts','ts',{unique:false});
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}
async function dbAddMany(items){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readwrite');
    const store = tx.objectStore(DB_STORE);
    items.forEach(it=>store.put(it));
    tx.oncomplete=()=>resolve();
    tx.onerror=()=>reject(tx.error);
  });
}
async function dbGetAll(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readonly');
    const store = tx.objectStore(DB_STORE);
    const req = store.getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=()=>reject(req.error);
  });
}
async function dbUpdate(item){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readwrite');
    tx.objectStore(DB_STORE).put(item);
    tx.oncomplete=()=>resolve();
    tx.onerror=()=>reject(tx.error);
  });
}
async function dbGet(id){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readonly');
    const req = tx.objectStore(DB_STORE).get(id);
    req.onsuccess=()=>resolve(req.result||null);
    req.onerror=()=>reject(req.error);
  });
}
async function dbClear(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readwrite');
    tx.objectStore(DB_STORE).clear();
    tx.oncomplete=()=>resolve();
    tx.onerror=()=>reject(tx.error);
  });
}

/* ========= Settings in localStorage ========= */
const LSK = {
  mute:'nc_mute',
  rigCat:'nc_rigCat',
  weights:'nc_weights',      // {id:number}
  queue:'nc_queue',          // [id,...]
  categories:'nc_categories' // {id:category}
};
function lsGet(k, fallback){ try{ const v = localStorage.getItem(k); return v?JSON.parse(v):fallback; }catch{ return fallback; } }
function lsSet(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ========= State ========= */
let IMAGES = []; // {id, blob, category, weight, ts}
let OBJECT_URLS = new Map(); // id -> objectURL
let isMuted = !!lsGet(LSK.mute,false);
let rigCategory = lsGet(LSK.rigCat,'')||'';
let rigQueue = lsGet(LSK.queue,[])||[];
let weightOverrides = lsGet(LSK.weights,{})||{};
let categoryOverrides = lsGet(LSK.categories,{})||{};

/* ========= Audio (WebAudio, iOS-safe) ========= */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    catch(e){ /* ignore */ }
  }
}
function playSpinStart(){
  if(isMuted||!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sawtooth';
  o.frequency.setValueAtTime(220,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(440,audioCtx.currentTime+0.2);
  g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.4,audioCtx.currentTime+0.05);
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.5);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+0.5);
}
function playTick(t=0){
  if(isMuted||!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='triangle';
  o.frequency.setValueAtTime(660,audioCtx.currentTime);
  g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.3,audioCtx.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.1);
  o.connect(g).connect(audioCtx.destination);
  o.start(audioCtx.currentTime + t); o.stop(audioCtx.currentTime + t + 0.12);
}
function playReveal(){
  if(isMuted||!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sine';
  o.frequency.setValueAtTime(523,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(880,audioCtx.currentTime+0.25);
  g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.5,audioCtx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.4);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+0.45);
}

/* ========= UI Elements ========= */
const fileInput = document.getElementById('fileInput');
const thumbsEl = document.getElementById('thumbs');
const revealEl = document.getElementById('reveal');
const reelsEl = document.getElementById('reels');
const spinBtn = document.getElementById('spinBtn');
const clearBtn = document.getElementById('clearBtn');
const statusEl = document.getElementById('status');
const filterSel = document.getElementById('categoryFilter');
const titleTap = document.getElementById('titleTap');
const rigDlg = document.getElementById('rig');
const rigClose = document.getElementById('rigClose');
const rigCategorySel = document.getElementById('rigCategory');
const rigGrid = document.getElementById('rigGrid');
const queueView = document.getElementById('queueView');
const queueId = document.getElementById('queueId');
const queueAdd = document.getElementById('queueAdd');
const queueClear = document.getElementById('queueClear');
const muteToggle = document.getElementById('muteToggle');
const muteState = document.getElementById('muteState');

/* ========= Init ========= */
(async function init(){
  db = await openDB();
  CATEGORIES.forEach(c=>{
    const o = document.createElement('option'); o.value=c; o.textContent=c; filterSel.appendChild(o);
  });
  CATEGORIES.forEach(c=>{
    const o = document.createElement('option'); o.value=c; o.textContent=c; rigCategorySel.appendChild(o);
  });
  if(rigCategory){ rigCategorySel.value = rigCategory; }
  muteState.textContent = isMuted ? "Muted" : "Sound on";

  await reloadImages();
  renderThumbs();
  renderReelStrips();
  renderRigGrid();
  renderQueue();

  status("Ready. Add images and spin âœ¨");
})();

/* ========= Loading & Rendering ========= */
async function reloadImages(){
  IMAGES = await dbGetAll();
  // apply overrides (weights/categories) persisted in localStorage
  IMAGES.forEach(it=>{
    if(weightOverrides[it.id] != null) it.weight = weightOverrides[it.id];
    if(categoryOverrides[it.id]) it.category = categoryOverrides[it.id];
  });
  // populate object URLs
  OBJECT_URLS.forEach(URL.revokeObjectURL); OBJECT_URLS.clear();
  IMAGES.forEach(it=>OBJECT_URLS.set(it.id, URL.createObjectURL(it.blob)));
  // build filter counts (optional)
}
function renderThumbs(){
  thumbsEl.innerHTML = '';
  if(!IMAGES.length){
    const p = document.createElement('div');
    p.className='hint'; p.textContent = "No images yet. Use â€œUpload imagesâ€ to add up to ~100 (device storage permitting).";
    thumbsEl.appendChild(p); return;
  }
  IMAGES.forEach(it=>{
    const d=document.createElement('div'); d.className='thumb'; d.dataset.id=it.id;
    const img=document.createElement('img'); img.loading='lazy'; img.src = OBJECT_URLS.get(it.id);
    const chip=document.createElement('div'); chip.className='chip'; chip.textContent=it.category||'Unassigned';
    const wt=document.createElement('div'); wt.className='weight-tag'; wt.textContent = `w${it.weight??DEFAULT_WEIGHT}`;
    d.appendChild(img); d.appendChild(chip); d.appendChild(wt);
    d.addEventListener('click', ()=>{
      // copy id for rig queue convenience
      navigator.clipboard?.writeText(it.id);
      status("Copied ID: "+it.id);
    });
    thumbsEl.appendChild(d);
  });
}
function renderReelStrips(){
  const reels = [...reelsEl.querySelectorAll('.reel .strip')];
  reels.forEach((strip,i)=>{
    strip.innerHTML='';
    // Build 10 cells (thumbnails or placeholders)
    const pool = IMAGES.length ? IMAGES : new Array(6).fill(null);
    for(let k=0;k<10;k++){
      const cell = document.createElement('div'); cell.className='cell';
      if(IMAGES.length){
        const it = pool[(k+i)%pool.length] || pool[0];
        const img = document.createElement('img'); img.src = OBJECT_URLS.get(it.id); cell.appendChild(img);
      }else{
        cell.innerHTML = `<div style="opacity:.6">â€”</div>`;
      }
      strip.appendChild(cell);
    }
  });
}
function renderRigGrid(){
  rigGrid.innerHTML='';
  IMAGES.forEach(it=>{
    const card=document.createElement('div'); card.className='rig-item'; card.dataset.id=it.id;
    const img=document.createElement('img'); img.src=OBJECT_URLS.get(it.id);
    const meta=document.createElement('div'); meta.className='meta';
    const idrow=document.createElement('div'); idrow.textContent = `ID: ${it.id}`;
    const sel=document.createElement('select');
    CATEGORIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
    sel.value = it.category||'Missionary';
    sel.onchange = async ()=>{
      it.category = sel.value;
      categoryOverrides[it.id] = it.category;
      lsSet(LSK.categories, categoryOverrides);
      await dbUpdate(it); renderThumbs();
    };
    const weightInput=document.createElement('input'); weightInput.type='number'; weightInput.min='0'; weightInput.step='0.1';
    weightInput.value = it.weight ?? DEFAULT_WEIGHT;
    weightInput.onchange = ()=>{
      const w = parseFloat(weightInput.value)||0;
      it.weight = Math.max(0,w);
      weightOverrides[it.id] = it.weight;
      lsSet(LSK.weights,weightOverrides);
      renderThumbs();
    };
    meta.append(idrow, sel, weightInput);
    card.append(img, meta);
    card.addEventListener('click', ()=>{
      navigator.clipboard?.writeText(it.id);
      toast("ID copied");
    });
    rigGrid.appendChild(card);
  });
}
function renderQueue(){
  queueView.innerHTML='';
  rigQueue.forEach((id,idx)=>{
    const p=document.createElement('div'); p.className='pill'; p.textContent=`${idx+1}: ${id}`;
    p.title='Tap to remove';
    p.addEventListener('click', ()=>{
      rigQueue.splice(idx,1);
      lsSet(LSK.queue,rigQueue);
      renderQueue();
    });
    queueView.appendChild(p);
  });
}

/* ========= Upload Handling ========= */
fileInput.addEventListener('change', async (ev)=>{
  const files = [...ev.target.files];
  if(!files.length) return;
  ensureAudio();
  status(`Importing ${files.length} image(s)â€¦`);
  const toAdd=[];
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    // Keep original blob
    const id = crypto.randomUUID();
    const blob = f.slice(0, f.size, f.type);
    const it = {
      id, blob,
      category: 'Missionary', // default; user can change
      weight: DEFAULT_WEIGHT,
      ts: Date.now()
    };
    toAdd.push(it);
  }
  await dbAddMany(toAdd);
  // Track overrides for categories/weights
  toAdd.forEach(it=>{
    categoryOverrides[it.id] = it.category;
    weightOverrides[it.id] = it.weight;
  });
  lsSet(LSK.categories,categoryOverrides);
  lsSet(LSK.weights,weightOverrides);

  await reloadImages();
  renderThumbs();
  renderReelStrips();
  renderRigGrid();
  status(`Added ${toAdd.length} image(s).`);
  fileInput.value='';
});

/* ========= Spinner Logic ========= */
let spinning=false;
spinBtn.addEventListener('click', async ()=>{
  ensureAudio();
  if(spinning) return;
  if(!IMAGES.length){ status("Add images first."); return; }
  spinning=true;
  playSpinStart();
  status("Spinningâ€¦");
  animateReels(SPIN_DURATION_MS);
  // tick sounds across the duration
  for(let t=0;t<SPIN_DURATION_MS;t+=260){ playTick(t/1000); }
  const pick = await pickImage();
  setTimeout(()=>{
    showReveal(pick);
    playReveal();
    spinning=false;
    status("Result locked.");
  }, SPIN_DURATION_MS);
});

function animateReels(ms){
  const reels = [...document.querySelectorAll('.strip')];
  reels.forEach((strip,i)=>{
    strip.style.transition='none';
    strip.style.transform='translateY(0px)';
    // Force reflow
    void strip.offsetHeight;
    const distance = 120*10*(i+3); // spin differing distances
    strip.style.transition=`transform ${ms/1000}s cubic-bezier(.22,.61,.36,1)`;
    strip.style.transform=`translateY(-${distance}px)`;
  });
}
function showReveal(item){
  revealEl.innerHTML='';
  const img = new Image();
  img.src = OBJECT_URLS.get(item.id);
  img.alt = item.category||'reveal';
  revealEl.appendChild(img);
  const wm = document.createElement('div');
  wm.className='watermark';
  wm.textContent = item.category || 'â€”';
  revealEl.appendChild(wm);
}

async function pickImage(){
  // Priority 1: queue
  if(rigQueue.length){
    const id = rigQueue.shift();
    lsSet(LSK.queue, rigQueue);
    renderQueue();
    const it = IMAGES.find(x=>x.id===id);
    if(it) return it; // if missing, fall through
  }
  // Pool considering filter preference (rigCategory) OR UI filter dropdown
  const activeFilter = rigCategory || filterSel.value || '';
  const pool = activeFilter ? IMAGES.filter(it=> (it.category===activeFilter)) : IMAGES.slice();
  if(!pool.length) return IMAGES[0];

  // Weighted random
  const weights = pool.map(it=> Math.max(0.0001, it.weight ?? DEFAULT_WEIGHT));
  const total = weights.reduce((a,b)=>a+b,0);
  let r = Math.random()*total;
  for(let i=0;i<pool.length;i++){
    if((r-=weights[i])<=0) return pool[i];
  }
  return pool[pool.length-1];
}

/* ========= Filter UI ========= */
filterSel.addEventListener('change', ()=>{ renderReelStrips(); });

/* ========= Triple-tap + PIN for Rig Menu ========= */
(function setupSecret(){
  let taps = [];
  const zone = titleTap;
  function isTripleTap(){
    const now = Date.now();
    taps = taps.filter(t=> now - t < 600);
    taps.push(now);
    return taps.length>=3;
  }
  // iOS-friendly: listen to touchstart; fall back to click
  zone.addEventListener('touchstart', async (e)=>{
    if(isTripleTap()){
      await openRig();
      taps = [];
    }
  },{passive:true});
  zone.addEventListener('click', async ()=>{
    if(isTripleTap()){
      await openRig();
      taps = [];
    }
  });

  async function openRig(){
    const pin = await promptPIN();
    if(pin!==PIN){ toast("Wrong PIN", true); return; }
    rigDlg.showModal();
  }
})();

function promptPIN(){
  return new Promise((resolve)=>{
    // Minimal inline PIN prompt (no hints)
    const d=document.createElement('dialog');
    d.style.border='none'; d.style.borderRadius='12px'; d.style.padding='16px';
    d.style.background='#11121b'; d.style.color='white';
    d.innerHTML=`<form method="dialog" style="display:grid;gap:10px">
      <div style="font-weight:600">Enter PIN</div>
      <input id="pinIn" type="password" inputmode="numeric" style="background:#0c0d15;color:#fff;border:1px solid #2b2c3e;border-radius:8px;padding:10px" autofocus maxlength="8" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel">Cancel</button>
        <button value="ok" class="primary">OK</button>
      </div>
    </form>`;
    document.body.appendChild(d);
    d.addEventListener('close', ()=>{
      const val = d.returnValue==='ok' ? d.querySelector('#pinIn').value : null;
      resolve(val);
      d.remove();
    });
    d.showModal();
  });
}

rigClose.addEventListener('click', ()=>rigDlg.close());
rigCategorySel.addEventListener('change', ()=>{
  rigCategory = rigCategorySel.value||'';
  lsSet(LSK.rigCat, rigCategory);
});
muteToggle.addEventListener('click', ()=>{
  isMuted = !isMuted;
  lsSet(LSK.mute,isMuted);
  muteState.textContent = isMuted ? "Muted" : "Sound on";
});

queueAdd.addEventListener('click', ()=>{
  const id = queueId.value.trim();
  if(!id) return;
  rigQueue.push(id);
  lsSet(LSK.queue, rigQueue);
  queueId.value='';
  renderQueue();
});
queueClear.addEventListener('click', ()=>{
  rigQueue.length = 0;
  lsSet(LSK.queue, rigQueue);
  renderQueue();
});

/* ========= Status & Toast ========= */
function status(msg){ statusEl.textContent = msg; }
function toast(msg, danger=false){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.left='50%'; t.style.bottom='24px'; t.style.transform='translateX(-50%)';
  t.style.background=danger?'#491a23':'#1a1a28';
  t.style.border='1px solid #2a2b40'; t.style.padding='10px 14px'; t.style.borderRadius='999px';
  t.style.zIndex='9999'; t.style.boxShadow='0 10px 30px rgba(0,0,0,.4)';
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; },1200);
  setTimeout(()=>t.remove(),1600);
}

/* ========= Reset (danger) ========= */
clearBtn.addEventListener('click', async ()=>{
  if(!confirm('Remove all images and settings?')) return;
  await dbClear();
  IMAGES = [];
  OBJECT_URLS.forEach(URL.revokeObjectURL); OBJECT_URLS.clear();
  localStorage.removeItem(LSK.weights);
  localStorage.removeItem(LSK.categories);
  localStorage.removeItem(LSK.queue);
  renderThumbs(); renderReelStrips(); renderRigGrid(); renderQueue();
  revealEl.innerHTML='<div class="watermark">Tap ðŸŽ° Spin</div>';
  status("Reset complete.");
});

/* ========= Utility: iOS wake-up for AudioContext ========= */
document.addEventListener('touchend', ()=>ensureAudio(), {passive:true});

/* ========= Populate category filter initially ========= */
(function fillFilter(){
  // Already added options in init; nothing else for now.
})();
</script>
</body>
</html>

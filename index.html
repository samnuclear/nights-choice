<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>The Night‚Äôs Choice</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0f">
<style>
  :root{
    --bg:#0b0b0f; --panel:#13131a; --panel2:#181824;
    --accent:#d79ab8; --accent2:#7ad1cc;
    --text:#f2f2f5; --muted:#a9abbb; --line:#24253a;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,11,15,.98),rgba(11,11,15,.7) 70%,rgba(11,11,15,0));backdrop-filter:blur(8px);border-bottom:1px solid #1b1c2a}
  .topbar{max-width:1100px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:calc(env(safe-area-inset-top) + 18px) 14px 12px}
  .title-tappable{font-weight:700;letter-spacing:.4px;font-size:20px;padding:8px 10px;border-radius:8px}
  .controls{display:flex;gap:8px;align-items:center}
  label.upload{display:inline-flex;align-items:center;gap:8px;border:1px dashed #34354a;padding:8px 10px;border-radius:10px;background:var(--panel2)}
  input[type=file]{display:none}
  button,select,textarea,input{background:var(--panel);color:var(--text);border:1px solid #222331;border-radius:10px;padding:10px 12px;font-size:14px}
  button.primary{background:linear-gradient(180deg,#272737,#1b1b28);border-color:#2b2c3d}
  button:disabled{opacity:.5}
  .pill{background:#1a1a28;border:1px solid #2a2b40;border-radius:999px;padding:6px 10px;font-size:12px;color:#ddd}
  .wrap{max-width:1100px;margin:0 auto;padding:0 14px 60px}
  .machine{margin-top:14px;background:radial-gradient(1200px 600px at 50% -200px,#1a1a26,#0e0e14 70%);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02)}
  .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .reel{height:160px;background:linear-gradient(180deg,#151521,#0f0f16);border:1px solid #23243a;border-radius:12px;overflow:hidden;position:relative}
  .strip{position:absolute;inset:0;display:flex;flex-direction:column;gap:0;will-change:transform,filter}
  .cell{height:160px;display:flex;align-items:center;justify-content:center}
  .cell img{height:100%;width:100%;object-fit:cover;border-radius:10px}
  .reveal-name{margin-top:12px;text-align:center;font-weight:700;color:var(--accent)}
  .reveal-big{margin-top:8px;border:1px solid #24253a;border-radius:14px;background:#0f0f15;min-height:42vh;display:grid;place-items:center;overflow:hidden}
  .reveal-big img{max-width:100%;max-height:100%;display:block}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px}
  .countdown{font-variant-numeric:tabular-nums}
  .hidden{display:none !important}

  /* Rig dialog mobile-first */
  dialog#rig{width:min(980px,98vw);max-height:90vh;border:none;border-radius:14px;background:linear-gradient(180deg,#13131c,#0c0c12);color:var(--text);padding:0;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.6)}
  #rig header{position:sticky;top:0;padding:14px;border-bottom:1px solid #27283c;background:#12121b;display:flex;gap:10px;align-items:center;z-index:2}
  #rig .body{padding:12px 14px;display:block;max-height:calc(90vh - 56px);overflow:auto}
  .section{background:#161625;border:1px solid #27283c;border-radius:12px;margin-bottom:10px}
  .section > .hdr{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #27283c}
  .section > .hdr button.toggle{margin-left:auto}
  .section .inner{padding:10px 12px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .rig-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
  .rig-item{position:relative;border:1px solid #2a2b40;background:#12121b;border-radius:10px;overflow:hidden}
  .rig-item img{width:100%;height:110px;object-fit:cover;display:block}
  .rig-item .meta{padding:6px 8px;font-size:12px;display:grid;gap:6px}
  .tag{position:absolute;left:6px;top:6px;background:#1a1a28;border:1px solid #2a2b40;border-radius:999px;padding:2px 6px;font-size:11px}
  .exclude-btn{position:absolute;right:6px;top:6px;border-radius:999px;padding:2px 6px;font-size:11px}
  .ok{color:#7cd992} .warn{color:#ffcf6e} .danger{color:#ff6e8a}
  .hint{font-size:12px;color:var(--muted)}
  textarea{width:100%;min-height:110px;resize:vertical}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div id="titleTap" class="title-tappable">The Night‚Äôs Choice</div>
    <div class="controls">
      <label class="upload">
        <input id="fileInput" type="file" accept="image/*" multiple>
        <span>‚ûï Upload</span>
      </label>
      <label class="pill" style="display:flex;align-items:center;gap:6px">
        ‚è±Ô∏è
        <select id="timerSelect" title="Timer">
          <option value="0">Off</option>
          <option value="1">1 min</option>
          <option value="2">2 min</option>
          <option value="3">3 min</option>
          <option value="4">4 min</option>
          <option value="5">5 min</option>
        </select>
      </label>
      <button id="spinBtn" class="primary">üé∞ Spin</button>
    </div>
  </div>
</header>

<div class="wrap">
  <section class="machine">
    <div class="reels" id="reels">
      <div class="reel"><div class="strip"></div></div>
      <div class="reel"><div class="strip"></div></div>
      <div class="reel"><div class="strip"></div></div>
    </div>

    <div id="revealName" class="reveal-name"></div>

    <div id="revealBig" class="reveal-big hidden">
      <img id="revealImg" alt="" />
    </div>

    <div class="toolbar">
      <span id="countdown" class="countdown hint"></span>
      <button id="skipBtn" class="pill" style="display:none">Skip</button>
    </div>
  </section>
</div>

<!-- Rig: triple-tap title + PIN 1616 -->
<dialog id="rig">
  <header>
    <strong>Rig Control</strong>
    <span class="hint">Private</span>
    <button id="rigClose" style="margin-left:auto">‚úï</button>
  </header>
  <div class="body">
    <!-- Controls -->
    <div class="section" id="secControls">
      <div class="hdr"><strong>Controls</strong><button class="toggle" data-target="controlsInner">‚ñº</button></div>
      <div class="inner" id="controlsInner">
        <div class="row" style="margin-bottom:8px">
          <input id="queueId" type="text" placeholder="Add by Image ID" style="flex:1;min-width:160px">
          <button id="queueAddId">Add</button>
          <select id="queueByDesc" style="flex:1;min-width:160px"></select>
          <button id="queueAddDesc">Add by Name</button>
          <button id="queueClear" class="warn">Clear queue</button>
        </div>
        <div id="queueView" class="row" style="gap:6px;flex-wrap:wrap"></div>
        <div class="row">
          <label>Restrict category</label>
          <select id="rigCategory"></select>
          <button id="muteToggle">Toggle mute</button>
          <span id="muteState" class="hint"></span>
        </div>
      </div>
    </div>

    <!-- Bulk tools -->
    <div class="section" id="secBulk">
      <div class="hdr"><strong>Bulk tools</strong><button class="toggle" data-target="bulkInner">‚ñº</button></div>
      <div class="inner" id="bulkInner">
        <div class="row">
          <!-- Fast Tag Mode -->
          <label class="hint">Fast Tag:</label>
          <select id="fastTagCategory"></select>
          <input id="fastTagName" type="text" placeholder="Name (optional)">
          <label class="row" style="gap:6px"><input id="fastTagEnable" type="checkbox"> Enable tap-to-apply</label>
        </div>
        <div class="row" style="margin-top:8px">
          <!-- Filters -->
          <label>Filter:</label>
          <select id="filterSelect">
            <option value="">All</option>
            <option value="uncategorized">Uncategorized</option>
            <option value="unnamed">Unnamed</option>
            <option value="excluded">Excluded (weight=0)</option>
          </select>
          <select id="filterCategory">
            <option value="">Category‚Ä¶</option>
          </select>
          <button id="applySetCategory" class="pill">Set category for filtered</button>
          <button id="applyIncludeAll" class="pill">Include filtered (w=1)</button>
          <button id="applyExcludeAll" class="pill danger">Exclude filtered (w=0)</button>
        </div>
        <div style="margin-top:10px">
          <div class="hint" style="margin-bottom:6px">Batch names (one per line) ‚Üí applies in order to current filtered list</div>
          <textarea id="batchNames" placeholder="e.g.&#10;Lotus&#10;Bridge&#10;Chair"></textarea>
          <div class="row" style="margin-top:6px">
            <button id="applyBatchNames">Apply names</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Grid -->
    <div class="section">
      <div class="hdr"><strong>Images</strong><span class="hint" id="gridCount"></span></div>
      <div class="inner">
        <div id="rigGrid" class="rig-grid"></div>
      </div>
    </div>
  </div>
</dialog>

<script>
/* -------------------- Config -------------------- */
const CATEGORIES = [
 "Missionary","Woman-on-top","Oral for Her","Oral for Him",
 "Sitting","Standing","Side-by-Side","Deep Penetration",
 "69","Rear Entry","BDSM for Lovers","Adventurous"
];
const DEFAULT_WEIGHT = 1;
const SPIN_DURATION_MS = 6000;
const PIN = "1616";

/* -------------------- Storage -------------------- */
const DB_NAME = 'nights-choice-db';
const DB_STORE = 'images';
const LSK = {
  mute:'nc_mute',
  rigCat:'nc_rigCat',
  weights:'nc_weights',
  queue:'nc_queue',
  categories:'nc_categories',
  descriptions:'nc_desc',
  timer:'nc_timer'
};

let db, IMAGES=[], OBJECT_URLS=new Map();
let isMuted = !!lsGet(LSK.mute,false);
let rigCategory = lsGet(LSK.rigCat,'')||'';
let rigQueue = lsGet(LSK.queue,[])||[];
let weightOverrides = lsGet(LSK.weights,{})||{};
let categoryOverrides = lsGet(LSK.categories,{})||{};
let descOverrides = lsGet(LSK.descriptions,{})||{};
let timerMinutes = +lsGet(LSK.timer,0)||0;

/* -------------------- Audio -------------------- */
let audioCtx=null;
function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } }
function playSpinStart(){ if(isMuted||!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sawtooth'; o.frequency.setValueAtTime(220,audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(660,audioCtx.currentTime+0.4); g.gain.setValueAtTime(0.0001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.35,audioCtx.currentTime+0.05); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.6); o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.65); }
function playTick(t=0){ if(isMuted||!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(700,audioCtx.currentTime+t); g.gain.setValueAtTime(0.0001,audioCtx.currentTime+t); g.gain.exponentialRampToValueAtTime(0.3,audioCtx.currentTime+t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+t+0.1); o.connect(g).connect(audioCtx.destination); o.start(audioCtx.currentTime+t); o.stop(audioCtx.currentTime+t+0.12); }
function playReveal(){ if(isMuted||!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(330,audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(880,audioCtx.currentTime+0.35); g.gain.setValueAtTime(0.0001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.5,audioCtx.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.45); o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.5); }
function playTimerChime(){ if(isMuted||!audioCtx) return; const now=audioCtx.currentTime; [[660,0],[990,0.2]].forEach(([f,dt])=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(f,now+dt); g.gain.setValueAtTime(0.0001,now+dt); g.gain.exponentialRampToValueAtTime(0.5,now+dt+0.02); g.gain.exponentialRampToValueAtTime(0.0001,now+dt+0.35); o.connect(g).connect(audioCtx.destination); o.start(now+dt); o.stop(now+dt+0.4); }); }

/* -------------------- UI refs -------------------- */
const fileInput = document.getElementById('fileInput');
const reelsEl = document.getElementById('reels');
const spinBtn = document.getElementById('spinBtn');
const revealNameEl = document.getElementById('revealName');
const revealBig = document.getElementById('revealBig');
const revealImg = document.getElementById('revealImg');
const countdownEl = document.getElementById('countdown');
const skipBtn = document.getElementById('skipBtn');
const timerSelect = document.getElementById('timerSelect');
const titleTap = document.getElementById('titleTap');
const rigDlg = document.getElementById('rig');
const rigClose = document.getElementById('rigClose');
const rigGrid = document.getElementById('rigGrid');
const rigCategorySel = document.getElementById('rigCategory');
const queueView = document.getElementById('queueView');
const queueId = document.getElementById('queueId');
const queueAddId = document.getElementById('queueAddId');
const queueByDesc = document.getElementById('queueByDesc');
const queueAddDesc = document.getElementById('queueAddDesc');
const muteToggle = document.getElementById('muteToggle');
const muteState = document.getElementById('muteState');

const secControls = document.getElementById('secControls');
const secBulk = document.getElementById('secBulk');
const fastTagCategory = document.getElementById('fastTagCategory');
const fastTagName = document.getElementById('fastTagName');
const fastTagEnable = document.getElementById('fastTagEnable');
const filterSelect = document.getElementById('filterSelect');
const filterCategory = document.getElementById('filterCategory');
const applySetCategory = document.getElementById('applySetCategory');
const applyIncludeAll = document.getElementById('applyIncludeAll');
const applyExcludeAll = document.getElementById('applyExcludeAll');
const batchNames = document.getElementById('batchNames');
const applyBatchNames = document.getElementById('applyBatchNames');
const gridCount = document.getElementById('gridCount');

/* -------------------- DB -------------------- */
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = (ev)=>{
      const db=ev.target.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        const store = db.createObjectStore(DB_STORE,{keyPath:'id'});
        store.createIndex('category','category',{unique:false});
        store.createIndex('ts','ts',{unique:false});
      }
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
function dbAddMany(items){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(DB_STORE,'readwrite');
    const st=tx.objectStore(DB_STORE);
    items.forEach(it=>st.put(it));
    tx.oncomplete=()=>resolve(); tx.onerror=()=>reject(tx.error);
  });
}
function dbGetAll(){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(DB_STORE,'readonly');
    const st=tx.objectStore(DB_STORE);
    const rq=st.getAll(); rq.onsuccess=()=>resolve(rq.result||[]); rq.onerror=()=>reject(rq.error);
  });
}
function dbUpdate(item){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).put(item);
    tx.oncomplete=()=>resolve(); tx.onerror=()=>reject(tx.error);
  });
}

/* -------------------- Init -------------------- */
(async function init(){
  db = await openDB();

  // Populate selects
  CATEGORIES.forEach(c=>{
    const ca=document.createElement('option'); ca.value=c; ca.textContent=c; rigCategorySel.appendChild(ca);
    const cb=document.createElement('option'); cb.value=c; cb.textContent=c; fastTagCategory.appendChild(cb);
    const cc=document.createElement('option'); cc.value=c; cc.textContent=c; filterCategory.appendChild(cc);
  });
  if(rigCategory) rigCategorySel.value = rigCategory;

  // timer
  timerSelect.value = String(timerMinutes);
  timerSelect.addEventListener('change', ()=>{ timerMinutes = +timerSelect.value; lsSet(LSK.timer,timerMinutes); });

  muteState.textContent = isMuted ? "Muted" : "Sound on";

  // collapsible
  document.querySelectorAll('.toggle').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = document.getElementById(btn.dataset.target);
      if(!target) return;
      const isHidden = target.classList.toggle('hidden');
      btn.textContent = isHidden ? '‚ñ≤' : '‚ñº';
    });
  });

  await reloadImages();
  buildReels();
  renderRig();
  renderQueue();
})();

/* -------------------- Load/Render -------------------- */
async function reloadImages(){
  IMAGES = await dbGetAll();
  IMAGES.forEach(it=>{
    if(weightOverrides[it.id] != null) it.weight = weightOverrides[it.id];
    if(categoryOverrides[it.id]) it.category = categoryOverrides[it.id];
    if(descOverrides[it.id]) it.description = descOverrides[it.id];
  });
  OBJECT_URLS.forEach(URL.revokeObjectURL); OBJECT_URLS.clear();
  IMAGES.forEach(it=>OBJECT_URLS.set(it.id, URL.createObjectURL(it.blob)));
}
function buildReels(){
  const strips = reelsEl.querySelectorAll('.strip');
  strips.forEach((strip,i)=>{
    strip.innerHTML='';
    const pool = IMAGES.length ? IMAGES.slice() : [];
    if(!pool.length){
      const c=document.createElement('div'); c.className='cell'; c.innerHTML='‚Äî'; strip.appendChild(c);
      return;
    }
    for(let k=0;k<12;k++){
      const it = pool[(k+i)%pool.length];
      const cell=document.createElement('div'); cell.className='cell';
      const img=document.createElement('img'); img.src=OBJECT_URLS.get(it.id); cell.appendChild(img);
      strip.appendChild(cell);
    }
  });
}
function getFilteredImages(){
  const f = filterSelect.value;
  const cat = filterCategory.value;
  let list = IMAGES.slice();
  if(f==='uncategorized') list = list.filter(x=>!x.category);
  if(f==='unnamed') list = list.filter(x=>!(x.description||'').trim());
  if(f==='excluded') list = list.filter(x=>(x.weight??DEFAULT_WEIGHT)==0);
  if(cat) list = list.filter(x=>x.category===cat);
  return list;
}
function renderRig(){
  const list = getFilteredImages();
  gridCount.textContent = `(${list.length} shown of ${IMAGES.length})`;
  rigGrid.innerHTML='';
  list.forEach(it=>{
    const card=document.createElement('div'); card.className='rig-item'; card.dataset.id=it.id;

    const img=document.createElement('img'); img.src=OBJECT_URLS.get(it.id);
    const tag=document.createElement('span'); tag.className='tag'; tag.textContent=it.category||'‚Äî';
    const ex=document.createElement('button'); ex.className='exclude-btn pill'; ex.textContent=(it.weight??DEFAULT_WEIGHT)==0?'Include':'Exclude';
    ex.addEventListener('click', (e)=>{ e.stopPropagation(); toggleExclude(it); });

    const meta=document.createElement('div'); meta.className='meta';
    const idrow=document.createElement('div'); idrow.textContent=`ID: ${it.id}`;
    const row1=document.createElement('div'); // category + weight
    const sel=document.createElement('select'); CATEGORIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
    sel.value = it.category||'Missionary';
    sel.onchange=async ()=>{ it.category=sel.value; categoryOverrides[it.id]=it.category; lsSet(LSK.categories,categoryOverrides); await dbUpdate(it); tag.textContent=it.category; };
    const w=document.createElement('input'); w.type='number'; w.min='0'; w.step='0.1'; w.style.width='80px'; w.value=it.weight??DEFAULT_WEIGHT;
    w.onchange=()=>{ const val=Math.max(0,parseFloat(w.value)||0); it.weight=val; weightOverrides[it.id]=val; lsSet(LSK.weights,weightOverrides); ex.textContent=val==0?'Include':'Exclude'; };
    row1.append(sel,' ',w);

    const d=document.createElement('input'); d.type='text'; d.placeholder='Description / Name'; d.value=it.description||'';
    d.onchange=()=>{ it.description=d.value.trim(); descOverrides[it.id]=it.description; lsSet(LSK.descriptions,descOverrides); refreshQueueDescOptions(); };

    meta.append(idrow,row1,d);
    card.append(img, tag, ex, meta);

    // Fast Tag Mode tap (live-sync chip + dropdown + name, no re-render)
card.addEventListener('click', ()=>{
  if(!fastTagEnable.checked) { navigator.clipboard?.writeText(it.id); toast('ID copied'); return; }

  const cat = fastTagCategory.value || it.category || 'Missionary';
  const name = (fastTagName.value||'').trim();

  // Update in-memory + persist
  it.category = cat;
  categoryOverrides[it.id] = cat;
  lsSet(LSK.categories, categoryOverrides);

  if(name){
    it.description = name;
    descOverrides[it.id] = name;
    lsSet(LSK.descriptions, descOverrides);
  }

  dbUpdate(it); // async, no await

  // Live visual sync (no flicker)
  tag.textContent = it.category; // chip
  sel.value = it.category;       // dropdown under image
  if(name){ d.value = it.description; } // name field

  // Keep the queue-by-name dropdown up-to-date
  refreshQueueDescOptions();

  toast('Applied');
});

    rigGrid.appendChild(card);
  });
  refreshQueueDescOptions();
}
function toggleExclude(it){
  const newW = (it.weight??DEFAULT_WEIGHT)==0 ? 1 : 0;
  it.weight = newW;
  weightOverrides[it.id]=newW; lsSet(LSK.weights,weightOverrides);
  renderRig();
}

/* -------------------- Bulk actions -------------------- */
applySetCategory.addEventListener('click', ()=>{
  const cat = fastTagCategory.value; if(!cat){ toast('Pick a category'); return; }
  const list = getFilteredImages();
  list.forEach(it=>{ it.category=cat; categoryOverrides[it.id]=cat; dbUpdate(it); });
  lsSet(LSK.categories,categoryOverrides); renderRig(); toast('Category set for filtered');
});
applyIncludeAll.addEventListener('click', ()=>{
  const list = getFilteredImages(); list.forEach(it=>{ it.weight=1; weightOverrides[it.id]=1; dbUpdate(it); });
  lsSet(LSK.weights,weightOverrides); renderRig(); toast('Included filtered');
});
applyExcludeAll.addEventListener('click', ()=>{
  const list = getFilteredImages(); list.forEach(it=>{ it.weight=0; weightOverrides[it.id]=0; dbUpdate(it); });
  lsSet(LSK.weights,weightOverrides); renderRig(); toast('Excluded filtered');
});
applyBatchNames.addEventListener('click', ()=>{
  const names = batchNames.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!names.length){ toast('No names provided'); return; }
  const list = getFilteredImages();
  let i=0;
  list.forEach(it=>{
    if(i<names.length){ it.description = names[i++]; descOverrides[it.id]=it.description; dbUpdate(it); }
  });
  lsSet(LSK.descriptions,descOverrides); renderRig(); toast('Names applied');
});

/* -------------------- Upload -------------------- */
fileInput.addEventListener('change', async (ev)=>{
  const files=[...ev.target.files]; if(!files.length) return;
  ensureAudio();
  const toAdd=[];
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    const id=crypto.randomUUID();
    const blob=f.slice(0, f.size, f.type);
    const it={ id, blob, category:'Missionary', weight:DEFAULT_WEIGHT, ts:Date.now(), description:'' };
    toAdd.push(it);
  }
  await dbAddMany(toAdd);
  toAdd.forEach(it=>{
    categoryOverrides[it.id]=it.category; weightOverrides[it.id]=it.weight; descOverrides[it.id]=it.description;
  });
  lsSet(LSK.categories,categoryOverrides); lsSet(LSK.weights,weightOverrides); lsSet(LSK.descriptions,descOverrides);
  await reloadImages(); buildReels(); renderRig(); fileInput.value='';
});

/* -------------------- Spin / Animation -------------------- */
let spinning=false, blockUntil=0, timerId=null;

spinBtn.addEventListener('click', async ()=>{
  ensureAudio();
  if(spinning) return;
  const now=Date.now();
  if(now<blockUntil){ return; }
  if(!IMAGES.length){ toast('Add images first'); return; }

  spinning=true;
  revealNameEl.textContent='';
  revealBig.classList.add('hidden');
  revealImg.removeAttribute('src');
  playSpinStart();

  const chosen = await pickImage();
  let others = IMAGES.filter(x=>x.id!==chosen.id);
  if(others.length<2) others = IMAGES.concat(IMAGES);
  shuffle(others);
  const leftImg = others[0], rightImg = others[1];

  const strips = [...document.querySelectorAll('.strip')];
  const finals = [leftImg, chosen, rightImg];

  const BASE=20, CELLH=160;
  strips.forEach((strip,i)=>{
    strip.innerHTML='';
    const pool = IMAGES.length ? IMAGES.slice() : [];
    for(let k=0;k<BASE;k++){
      const it=pool[(k+i)%pool.length];
      const cell=document.createElement('div'); cell.className='cell';
      const img=document.createElement('img'); img.src=OBJECT_URLS.get(it.id); cell.appendChild(img);
      strip.appendChild(cell);
    }
    const end=document.createElement('div'); end.className='cell';
    const endImg=new Image(); endImg.src=OBJECT_URLS.get(finals[i].id);
    end.appendChild(endImg); strip.appendChild(end);

    strip.style.transition='none';
    strip.style.transform='translateY(0px)';
    strip.style.filter='blur(6px) brightness(0.9)';
  });

  const offsets=[0, 250, 450];
  const ease='cubic-bezier(.12,.62,.22,.99)';

  strips.forEach((strip,i)=>{
    const distance = CELLH * (BASE); // land with final visible
    setTimeout(()=>{ strip.style.transition=`transform ${SPIN_DURATION_MS/1000}s ${ease}, filter ${SPIN_DURATION_MS/1000}s linear`; strip.style.transform=`translateY(-${distance}px)`; }, offsets[i]);
  });

  for(let t=0;t<SPIN_DURATION_MS*0.6;t+=280){ playTick(t/1000); }

  setTimeout(()=>{
    strips.forEach(s=>{ s.style.filter='none'; });
    playReveal();
    const name = (chosen.description||chosen.category||'');
    revealNameEl.textContent = name;
    revealImg.src = OBJECT_URLS.get(chosen.id);
    revealBig.classList.remove('hidden');
    spinning=false;

    if(timerMinutes>0){ startCountdown(timerMinutes); }
  }, SPIN_DURATION_MS + Math.max(...offsets) + 50);
});

/* -------------------- Countdown + Skip -------------------- */
function clearCountdownAndUnlock(){
  if(timerId) clearInterval(timerId);
  timerId = null;
  blockUntil = 0;
  spinBtn.disabled = false;
  countdownEl.textContent = '';
  skipBtn.style.display = 'none';
}
function startCountdown(mins){
  const duration = mins*60*1000;
  blockUntil = Date.now()+duration;
  spinBtn.disabled = true;
  if(timerId) clearInterval(timerId);
  updateCountdown();
  skipBtn.style.display = 'inline-flex';
  timerId = setInterval(()=>{
    updateCountdown();
    if(Date.now()>=blockUntil){
      clearInterval(timerId); timerId=null; spinBtn.disabled=false; countdownEl.textContent=''; skipBtn.style.display='none'; playTimerChime();
    }
  }, 250);
}
function updateCountdown(){
  const remain = Math.max(0, blockUntil - Date.now());
  const s = Math.ceil(remain/1000);
  const m = Math.floor(s/60), ss = String(s%60).padStart(2,'0');
  countdownEl.textContent = `Next spin in ${m}:${ss}`;
}
skipBtn.addEventListener('click', clearCountdownAndUnlock);

/* -------------------- Pick logic -------------------- */
async function pickImage(){
  if(rigQueue.length){
    const item = rigQueue.shift();
    lsSet(LSK.queue,rigQueue); renderQueue();
    if(item.startsWith('desc::')){
      const d = item.slice(6);
      const found = IMAGES.find(x=>(x.description||'')===d);
      if(found) return found;
    }else{
      const found = IMAGES.find(x=>x.id===item);
      if(found) return found;
    }
  }
  const filter = rigCategory || '';
  const pool = filter ? IMAGES.filter(it=>it.category===filter) : IMAGES.slice();
  if(!pool.length) return IMAGES[0];

  const weights = pool.map(it=> Math.max(0.0001, it.weight??DEFAULT_WEIGHT));
  const total = weights.reduce((a,b)=>a+b,0);
  let r = Math.random()*total;
  for(let i=0;i<pool.length;i++){ if((r-=weights[i])<=0) return pool[i]; }
  return pool[pool.length-1];
}

/* -------------------- Rig controls -------------------- */
(function secret(){
  const TAP_WINDOW = 800, LONG_PRESS_MS = 900;
  let taps = [], pressTimer=null;

  function isTriple(){ const now=Date.now(); taps=taps.filter(t=>now-t<TAP_WINDOW); taps.push(now); return taps.length>=3; }
  async function tryOpenRig(){ const pin = await promptPIN(); if(pin!==PIN){ toast('Wrong PIN', true); return; } rigDlg.showModal(); }

  titleTap.addEventListener('touchend', async ()=>{ if(isTriple()) { taps=[]; await tryOpenRig(); } }, {passive:true});
  titleTap.addEventListener('click',     async ()=>{ if(isTriple()) { taps=[]; await tryOpenRig(); } });
  titleTap.addEventListener('touchstart', ()=>{ clearTimeout(pressTimer); pressTimer=setTimeout(()=>{ taps=[]; tryOpenRig(); }, LONG_PRESS_MS); }, {passive:true});
  titleTap.addEventListener('touchend',   ()=> clearTimeout(pressTimer), {passive:true});
  titleTap.addEventListener('mousedown',  ()=>{ clearTimeout(pressTimer); pressTimer=setTimeout(()=>{ taps=[]; tryOpenRig(); }, LONG_PRESS_MS); });
  titleTap.addEventListener('mouseup',    ()=> clearTimeout(pressTimer));
})();
rigClose.addEventListener('click', ()=>rigDlg.close());
rigCategorySel.addEventListener('change', ()=>{ rigCategory = rigCategorySel.value||''; lsSet(LSK.rigCat,rigCategory); });
muteToggle.addEventListener('click', ()=>{ isMuted=!isMuted; lsSet(LSK.mute,isMuted); muteState.textContent = isMuted?'Muted':'Sound on'; });

queueAddId.addEventListener('click', ()=>{
  const id = queueId.value.trim(); if(!id) return;
  rigQueue.push(id); lsSet(LSK.queue,rigQueue); queueId.value=''; renderQueue();
});
queueAddDesc.addEventListener('click', ()=>{
  const val = queueByDesc.value; if(!val) return;
  rigQueue.push('desc::'+val); lsSet(LSK.queue,rigQueue); renderQueue();
});
queueClear.addEventListener('click', ()=>{ rigQueue.length=0; lsSet(LSK.queue,rigQueue); renderQueue(); });

function renderQueue(){
  queueView.innerHTML='';
  rigQueue.forEach((q,idx)=>{
    const pill=document.createElement('span'); pill.className='pill';
    pill.textContent = q.startsWith('desc::') ? `#${idx+1} ${q.slice(6)}` : `#${idx+1} ${q}`;
    pill.style.cursor='pointer';
    pill.title='Tap to remove';
    pill.onclick=()=>{ rigQueue.splice(idx,1); lsSet(LSK.queue,rigQueue); renderQueue(); };
    queueView.appendChild(pill);
  });
}
function refreshQueueDescOptions(){
  const names = IMAGES.map(x=>x.description||'').filter(Boolean);
  names.sort((a,b)=>a.localeCompare(b));
  const uniq=[...new Set(names)];
  queueByDesc.innerHTML='';
  const empty=document.createElement('option'); empty.value=''; empty.textContent='Select a name‚Ä¶'; queueByDesc.appendChild(empty);
  uniq.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; queueByDesc.appendChild(o); });
}

/* -------------------- Helpers -------------------- */
function lsGet(k,f){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):f;}catch{ return f; } }
function lsSet(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function toast(msg, danger=false){
  const t=document.createElement('div'); t.textContent=msg;
  Object.assign(t.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',background:danger?'#491a23':'#1a1a28',border:'1px solid #2a2b40',padding:'10px 14px',borderRadius:'999px',zIndex:9999,boxShadow:'0 10px 30px rgba(0,0,0,.4)'});
  document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; },1200); setTimeout(()=>t.remove(),1600);
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* Minimal inline PIN prompt */
function promptPIN(){
  return new Promise((resolve)=>{
    const d=document.createElement('dialog');
    Object.assign(d.style,{border:'none',borderRadius:'12px',padding:'16px',background:'#11121b',color:'#fff'});
    d.innerHTML=`<form method="dialog" style="display:grid;gap:10px">
      <div style="font-weight:600">Enter PIN</div>
      <input id="pinIn" type="password" inputmode="numeric" style="background:#0c0d15;color:#fff;border:1px solid #2b2c3e;border-radius:8px;padding:10px" autofocus maxlength="8" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel">Cancel</button>
        <button value="ok" class="primary">OK</button>
      </div>
    </form>`;
    document.body.appendChild(d);
    d.addEventListener('close', ()=>{
      const val = d.returnValue==='ok' ? d.querySelector('#pinIn').value : null;
      resolve(val); d.remove();
    });
    d.showModal();
  });
}

/* iOS audio unlock */
document.addEventListener('touchend', ()=>ensureAudio(), {passive:true});
</script>
</body>
</html>